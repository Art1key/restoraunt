{% extends 'base.html' %}
{% load static %}
{% block title %}–ë–ª—é–¥–∞{% endblock %}

{% block content %}
<link rel="shortcut icon" href="{% static 'css/icon.png' %}" type="image/png">
<style>.logo {
    margin-top: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
  }
  </style>
<link rel="stylesheet" href="{% static 'css/bluda.css' %}">
    <h3 style="text-align: center;">–°–ø–∏—Å–æ–∫ –±–ª—é–¥</h3>

    <!-- Search Form -->
    <form method="GET" style=" display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    align-content: center;
    justify-content: center;">
        <div>
            <a href="{% url 'add_dish' %}" class="add-dish-button" style="margin-bottom: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</a>
        </div>
    </form>

    <table style="margin-top: 20px;">
        <thead>
            <tr>
                <th style="padding: 10px; text-align: center;">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</th>
                <th style="padding: 10px; text-align: center;">–°–µ–∑–æ–Ω</th>
                <th style="padding: 10px; text-align: center;">–¢–∏–ø</th>
                <th style="padding: 10px; text-align: center;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π / –≤–µ—Å –æ–¥–Ω–æ–π –ø–æ—Ä—Ü–∏–∏</th>
                <th style="padding: 10px; text-align: center;">–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å</th>
                <th style="padding: 10px; text-align: center;">–í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</th>
                <th style="padding: 10px; text-align: center;">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <th style="padding: 10px; text-align: center;">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã<a href="{% url 'add_order' %}" class="add-dish-button">üîº</a></th>
            </tr>
        </thead>
        <tbody>
            {% if dishes %}
                {% for dish in dishes %}
                <tr>
                    <td style="padding: 10px; text-align: center;">{{ dish.name }}<a class="smile" href="{% url 'bluds_edit' dish_id=dish.id %}">üìù</a><a class="smile" href="{% url 'delete' dish_id=dish.id %}">‚ùå</a></td>
                    <td style="padding: 10px; text-align: center;">{{ dish.season }}</td>
                    <td style="padding: 10px; text-align: center;">{{ dish.type }}</td>
                    <td style="padding: 10px; text-align: center;">{{ dish.order_set.count }} / {{ dish.weight }}</td>
                    <td style="padding: 10px; text-align: center;">{{ dish.calory }}</td>
                    <td style="padding: 10px; text-align: center;">{{ dish.timehours }}</td>
                    <td style="padding: 10px; text-align: center;">{{ dish.price_dish }}</td>
                    <td style="padding: 10px; text-align: center;">
                        {% for order in dish.order_set.all %}
                            {{ order.name.name }} (–ø–æ—Ä—è–¥–æ–∫ - {{ order.order }}, {{ order.amount }} {{ order.name.unit }}<a href="{% url 'delete_order' order_id=order.id %}">‚ùå</a><a class="smile" href="{% url 'edit_order' order_id=order.id %}">üìù</a>)
                            {% if not forloop.last %}, {% endif %}
                        {% empty %}
                            –ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
                        {% endfor %}
                    </td>
                </tr>
                
                
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" style="text-align: center;">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <button onclick="exportToJson('dishes.json')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON</button>

    <script>
        function exportToJson(filename) {
            var dishes = Array.from(document.querySelectorAll('tbody tr')).map(function(row) {
                var cols = row.querySelectorAll('td');
                return {
                    name: cols[0].innerText,
                    season: cols[1].innerText,
                    servings: cols[2].innerText,
                    ingredients: cols[3].innerText
                };
            });
    
            var json = JSON.stringify(dishes, null, 2);
    
            var element = document.createElement('a');
            element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(json));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    
            var searchForm = document.getElementById('searchForm');
            var searchResults = document.getElementById('searchResults');

            searchForm.addEventListener('submit', function(event) {
                event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

                var searchQuery = this.search_query.value.trim().toLowerCase();
                var dishes = document.querySelectorAll('tbody tr');

                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                searchResults.innerHTML = '';

                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –±–ª—é–¥—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
                dishes.forEach(function(dish) {
                    var name = dish.querySelector('td:nth-child(1)').innerText.toLowerCase();
                    var season = dish.querySelector('td:nth-child(2)').innerText.toLowerCase();
                    var type = dish.querySelector('td:nth-child(3)').innerText.toLowerCase();

                    if (name.includes(searchQuery) || season.includes(searchQuery) || type.includes(searchQuery)) {
                        // –ë–ª—é–¥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                        searchResults.appendChild(dish.cloneNode(true));
                    }
                });

                if (searchResults.childElementCount === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    var noResultsMessage = document.createElement('p');
                    noResultsMessage.textContent = '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
                    searchResults.appendChild(noResultsMessage);
                }
            });
    </script>

{% endblock %}
